# Atom-Helper å°è„šæœ¬

è¿™å‡ å¤©åœ¨å°è¯•ç”¨æ–°çš„æ–‡æœ¬ç¼–è¾‘å™¨ Atomï¼Œä¸Šæ‰‹ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è£…æ’ä»¶å’¯ã€‚Atom å’Œ Sublime ä¸€æ ·ï¼Œç¤¾åŒºæä¾›äº†å„ç§å„æ ·çš„æ’ä»¶ï¼Œæ¥æä¾›é…·ç‚«çš„åŠŸèƒ½ã€‚ æˆ‘åœ¨ Atom ç½‘ç«™ä¸Šæœç´¢å¾ˆå¤šæ’ä»¶ç„¶åçœ‹çœ‹ä»‹ç»ä¸‹è½½ä½“éªŒï¼Œé…ç½®äº†ä¸€ä¸ªç®€å•çš„ Python å¼€å‘ç¯å¢ƒã€‚

è¿™ä¸ªæ—¶å€™å°±æƒ³å†™ä¸ªå°è„šæœ¬ç©ç©äº†ï¼Œå¤§æ¦‚åŠŸèƒ½å°±æ˜¯æ ¹æ®å…³é”®å­—æœç´¢ Atom çš„æ’ä»¶æˆ–è€…ä¸»é¢˜ï¼Œç„¶åæ’åºå±•ç¤ºå‰ N ä¸ªé¡¹ç›®ï¼Œå½“ç„¶ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œæ”¹å˜å‚æ•°å°±æ›´å¥½äº†ã€‚

Atom æ’ä»¶åœ°å€ï¼š[Packages](https://atom.io/packages)

Atom ä¸»é¢˜åœ°å€ï¼š[Themes](https://atom.io/themes)

# åˆ†æé—®é¢˜

æ•´ä¸ªè„šæœ¬æµç¨‹ï¼š

1. æ ¹æ®å…³é”®å­—å‘å‡ºç¬¬ä¸€ä¸ªæœç´¢è¯·æ±‚
2. è§£æå‡ºé¡µé¢ä¸­çš„æ’ä»¶æ•°æ®
3. æ‰¾åˆ°ã€Œä¸‹ä¸€é¡µã€çš„é“¾æ¥ï¼Œè¯·æ±‚ä¸‹ä¸€é¡µ
4. å¾ªç¯ 2-3ï¼Œç›´åˆ°æœ€åä¸€é¡µï¼Œå³ã€Œä¸‹ä¸€é¡µã€çš„é“¾æ¥ä¸å­˜åœ¨
5. å¯¹è·å–åˆ°çš„æ’ä»¶è¿›è¡Œæ’åºï¼Œç„¶åè¾“å‡º topN

å…ˆæ‰‹åŠ¨æœç´¢ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨ Chrome å¼€å‘è€…å·¥å…·æŸ¥çœ‹ä¸€ä¸‹è¯·æ±‚å†…å®¹ï¼š

![Search](http://ww4.sinaimg.cn/large/006y8mN6gw1f9v6ufxhuij30m80csdgm.jpg)

è¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ GET è¯·æ±‚ï¼Œç›´æ¥æŠŠå…³é”®å­—ä½œä¸ºå‚æ•°æ·»åŠ åœ¨ url åé¢å°±å¥½äº†ã€‚

æ¥ä¸‹æ¥æŸ¥çœ‹ä¸€ä¸‹é¡µé¢çš„ HTML å…ƒç´ ï¼š

![HTML](http://ww3.sinaimg.cn/large/006y8mN6gw1f9vct78948j30go0f8gmt.jpg)

å¯ä»¥æ ¹æ® `class="grid-cell"` è¿™ä¸€å±æ€§ï¼ŒæŠŠæ¯ä¸€ä¸ªæ’ä»¶ä½œä¸ºæ•´ä½“æå–å‡ºæ¥ï¼Œç„¶åå†è¯¦ç»†åœ°è§£æå‡ºå…·ä½“çš„å­—æ®µã€‚

ç„¶åæ‰¾ä¸€ä¸‹ ã€Œä¸‹ä¸€é¡µã€çš„é“¾æ¥ï¼š

![Next](http://ww3.sinaimg.cn/large/006y8mN6gw1f9vcuu27iuj30m801s74c.jpg)

![Next empty](http://ww3.sinaimg.cn/large/006y8mN6gw1f9vcvvflcaj30m801kdfs.jpg)

è¿™ä¹ŸéªŒè¯äº†å‰é¢çš„æƒ³æ³•ï¼Œæœ€åä¸€é¡µçš„æ—¶å€™ï¼Œã€Œä¸‹ä¸€é¡µã€çš„é“¾æ¥ä¸å­˜åœ¨ï¼Œè¿™æ ·å°±èƒ½æ­£ç¡®åœ°ç»“æŸå¾ªç¯è¯·æ±‚äº†ã€‚

æœ€åå°±æ˜¯è·å–ä¸€ä¸‹ topN çš„æ•°æ®ï¼Œç„¶åè¾“å‡ºå‡ºæ¥äº†ã€‚

# è·å–æ•°æ®

é¦–å…ˆæ ¹æ®å‰é¢åˆ†æçš„ç»“æœï¼Œå…ˆå†™ä¸€ä¸ªå¤§æ¦‚çš„ç±»ç»“æ„ï¼Œæœ‰å‡ ä¸ªæ–¹æ³•éœ€è¦å®ç°ã€‚

```python
class AtomHelper(object):
    def __init__(self, args):
        pass

    def extract_item(self, cell):
        """Extract item from cells."""
        pass

    def run(self):
        """Do search!"""
        pass

    def topN(self, N=10):
        """Get topN items."""
        pass
```

## è§£æå­—æ®µ

è¿™ä¸ªæ­¥éª¤ç›´æ¥ä½¿ç”¨ lxml çš„ xpath è¿›è¡Œè§£æå°±å¥½äº†ï¼Œç†Ÿæ‚‰ xpath çš„è¯å¾ˆç®€å•ï¼Œæœ€åæŠŠå­—æ®µç»„è£…æˆä¸€ä¸ªå­—å…¸ã€‚

```python
def extract_item(self, cell):
    """Extract item from cells."""

    # Extract title, url, desc, download ...
    # ...

    star = self.first(cell.xpath('.//a[@class="social-count"]/text()'))

    return {
        'title': title,
        'url': url,
        'desc': desc,
        'download': self.number_format(download),
        'star': self.number_format(star),
    }
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`xpath` æ–¹æ³•è¿”å›çš„é€šå¸¸éƒ½æ˜¯ `list` å¯¹è±¡ï¼Œé€šå¸¸éƒ½åªéœ€è¦ç¬¬ä¸€é¡¹ã€‚æ‰€ä»¥è¿™é‡Œå†™äº†ä¸€ä¸ªæ–¹æ³•æ¥ä»åºåˆ—ä¸­æå–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæä¾›é»˜è®¤å€¼é¿å…æ¯æ¬¡åˆ¤ç©ºã€‚

```python
def first(seq, default=''):
    """Extract first item in sequence, or default value."""
    return seq[0] if seq else default
```

å¦å¤–ç½‘ç«™ä¸Šçš„æ•°å­—æ˜¯æ ¼å¼åŒ–åçš„ï¼Œå³ `2,333` çš„å½¢å¼ï¼Œéœ€è¦è½¬æ¢æˆæ­£å¸¸çš„æ•°å­—ã€‚

```python
def number_format(num_str):
    """Convert number string like '2,333' to integer."""
    return int(num_str.replace(',', '').strip()) if num_str else num_str
```

## å¾ªç¯è¯·æ±‚é¡µé¢

è¿™ä¸€éƒ¨åˆ†å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­åœ°è¯·æ±‚ã€Œä¸‹ä¸€é¡µã€çš„åœ°å€ï¼ŒåŒæ—¶è§£æé¡µé¢ä¸­çš„æ•°æ®å’Œä¸‹ä¸€ä¸ªé“¾æ¥ã€‚

```python
def run(self):
    """Do search!"""

    next_url = self.search_url
    while next_url:
        html = etree.HTML(requests.get(next_url).text)

        # Extract cells, next_url
        # ...

        self.items.extend(map(self.extract_item, cells))
```

## è·å– topN

è¿™ä¸ªç”¨ä¸€ä¸‹å†…ç½®å‡½æ•° `sorted` å°±å¥½äº†ã€‚

```python
def topN(self, N=10, by='download'):
    return sorted(self.items, key=lambda item: item[by], reverse=True)[:N]
```

ç„¶åæŠŠå…·ä½“å®ç°çš„ä»£ç ç»„è£…èµ·æ¥ï¼Œæ·»åŠ ä¸€äº›å¿…è¦çš„è¾“å‡ºæç¤ºï¼Œä¸»ä½“åŠŸèƒ½å°±å®Œæˆäº†ã€‚

# æ·»åŠ å‘½ä»¤è¡Œå‚æ•°

è„šæœ¬å¯ä»¥æœç´¢ã€Œæ’ä»¶ã€æˆ–è€…ã€Œä¸»é¢˜ã€ï¼Œè¿™ä¸ªéœ€è¦æšä¸¾å‚æ•°æ¥æ§åˆ¶ï¼›è¾“å‡ºå¤šå°‘ä¸ªç»“æœï¼Œä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ªå‚æ•°ï¼›æ˜¯æŒ‰ä¸‹è½½é‡æ’åºè¿˜æ˜¯æ˜Ÿæ˜Ÿæ•°é‡æ’åºï¼Œè¿˜éœ€è¦ä¸€ä¸ªæšä¸¾å‚æ•°ã€‚

> `argparse` æ¨¡å—ä½¿å¾—ç¼–å†™ç”¨æˆ·å‹å¥½çš„å‘½ä»¤è¡Œæ¥å£éå¸¸å®¹æ˜“ã€‚ç¨‹åºåªéœ€å®šä¹‰å¥½å®ƒè¦æ±‚çš„å‚æ•°ï¼Œç„¶å `argparse` å°†è´Ÿè´£å¦‚ä½•ä» `sys.argv` ä¸­è§£æå‡ºè¿™äº›å‚æ•°ã€‚`argparse` æ¨¡å—è¿˜ä¼šè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©å’Œä½¿ç”¨ä¿¡æ¯å¹¶ä¸”å½“ç”¨æˆ·èµ‹ç»™ç¨‹åºéæ³•çš„å‚æ•°æ—¶äº§ç”Ÿé”™è¯¯ä¿¡æ¯ã€‚

`argparse` è¿™ä¸ªåº“ç®€å•æ˜“ç”¨ï¼Œæ–‡æ¡£å†™å¾—å¾ˆè¯¦ç»†ï¼Œè¿˜æœ‰å„ç§ç¤ºä¾‹ã€‚[æˆ³è¿™é‡Œ](http://python.usyiyi.cn/python_278/library/argparse.html)

```python
def process_arg():
    parser = argparse.ArgumentParser(
        description='Atom helper to search packages or themes.',
        epilog='Have fun :)')

    parser.add_argument('keyword',
                        nargs='+', help='The keyword to search.')

    parser.add_argument('-n', type=int, default=5,
                        help='Show top N items.(default 5)')
    parser.add_argument('-t', '--type', choices=('packages', 'themes'),
                        default='packages',
                        help='The type to search.(default packages)')
    parser.add_argument('-s', '--sort', choices=('download', 'star'),
                        default='download',
                        help='Sort items by.(default download)')
    parser.add_argument('-v', '--verbose', action='store_true',
                        help='Show debug messages.')

    args = vars(parser.parse_args())
    args.update(keyword='+'.join(args['keyword']))
    return args
```

è¿™é‡Œä¸»è¦çš„å‡ ä¸ªå‚æ•°ï¼š

![args](http://ww1.sinaimg.cn/large/006y8mN6gw1f9vcnvzmjrj30go09z3zg.jpg)

- `-t` æŒ‡å®šæœç´¢ç±»å‹
- `-s` æŒ‡å®šæ’åºè§„åˆ™
- `-n` æŒ‡å®šè¾“å‡ºå¤šå°‘ä¸ªæ•°æ®
- `-v` æ˜¾ç¤º debug ä¿¡æ¯
- `-g` æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

# æœ€ç»ˆç»“æœ

![final](http://ww1.sinaimg.cn/large/006y8mN6gw1f9vcmj4wt9j30m80bv0tv.jpg)

èŠ±æ—¶é—´å†™å®Œè¿™ä¸ªè„šæœ¬ï¼Œå‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ğŸ˜‚ï¼Œè¿˜ä¸å¦‚è‡ªå·±å»ç½‘ç«™ä¸Šæœæœå‘¢ã€‚

ä¸è¿‡ç¬¬ä¸€æ¬¡å†™å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„Ÿè§‰è¿˜æ˜¯æŒºå¥½ç©çš„ï¼Œç†Ÿæ‚‰äº†ä¸‹ `argparse` æ¨¡å—ï¼Œä»¥åç”¨ Python å†™å°å·¥å…·æ›´æ–¹ä¾¿äº†ã€‚

å®Œæ•´è„šæœ¬åœ°å€: [atom_helper.py](https://github.com/brucezz/SomeScripts/blob/master/atom_helper.py), æ¬¢è¿æ‹ç –è¯„è®ºã€‚

# Reference

- [argparse å®˜ç½‘æ–‡æ¡£](http://python.usyiyi.cn/python_278/library/argparse.html)
- [argparse - å‘½ä»¤è¡Œé€‰é¡¹ä¸å‚æ•°è§£æï¼ˆè¯‘ï¼‰](http://blog.xiayf.cn/2013/03/30/argparse/)
